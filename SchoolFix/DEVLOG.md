# ğŸ› ï¸ é–‹ç™¼æ—¥èªŒ - GAS è¸©é›·è¨˜éŒ„

> è¨˜éŒ„ SchoolFix é–‹ç™¼éç¨‹ä¸­é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆï¼Œé¿å…æœªä¾†è¸©é›·ã€‚

---

## ï¿½ é™¤éŒ¯éç¨‹å¯¦éŒ„

> **èª å¯¦è¨˜éŒ„**ï¼šä»¥ä¸‹æ˜¯èˆ‡ AI åŠ©æ‰‹åˆä½œé–‹ç™¼æ™‚çš„å¯¦éš›é™¤éŒ¯éç¨‹ï¼ŒåŒ…å«å¤šæ¬¡éŒ¯èª¤å˜—è©¦ã€‚

### å•é¡Œï¼šç®¡ç†å¾Œå°é¡¯ç¤º 0 ç­†å ±ä¿®å–®

**ç—‡ç‹€**ï¼š
- å ±ä¿®è¡¨å–®æäº¤æˆåŠŸï¼ˆè³‡æ–™æœ‰å¯«å…¥ Google Sheetï¼‰
- ä½†ç®¡ç†å¾Œå°é¡¯ç¤ºã€Œæ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±ä¿®å–®ã€
- åœ¨ GAS ç·¨è¼¯å™¨ç›´æ¥åŸ·è¡Œ `getRepairRequests` å¯ä»¥å›å‚³è³‡æ–™

**éŒ¯èª¤çš„é™¤éŒ¯æ–¹å‘ï¼ˆæµªè²»æ™‚é–“ï¼‰**ï¼š
1. âŒ ä¸€ç›´è®“ç”¨æˆ¶åŸ·è¡Œæ¸¬è©¦å‡½å¼ã€æˆªåœ–ã€è²¼ log
2. âŒ æ‡·ç–‘æ˜¯éƒ¨ç½²å•é¡Œï¼Œåè¦†è®“ç”¨æˆ¶é‡æ–°éƒ¨ç½²
3. âŒ æ‡·ç–‘æ˜¯è©¦ç®—è¡¨æ¬Šé™å•é¡Œ
4. âŒ æ‡·ç–‘æœ‰å¤šå€‹åŒåè©¦ç®—è¡¨è¡çª

**ç”¨æˆ¶çš„åé¥‹**ï¼š
> ã€Œä½ ä¸€ç›´è®“æˆ‘æ¸¬è©¦é€™äº›æœ‰çš„æ²’çš„ï¼Œå¹¹å˜›ä¸å»å¥½å¥½æ€è€ƒä½ æ•´å€‹ç¨‹å¼ç¢¼éŒ¯èª¤åœ¨å“ªè£¡ã€

**å¯¦éš›æ ¹æœ¬åŸå› **ï¼š
- `getRepairRequests` å›å‚³çš„ç‰©ä»¶åŒ…å« Date ç‰©ä»¶
- Date ç‰©ä»¶é€é `google.script.run` ç„¡æ³•æ­£ç¢ºåºåˆ—åŒ–
- å°è‡´å‰ç«¯æ”¶åˆ° `null` æˆ–ç©ºé™£åˆ—

**æ•™è¨“**ï¼š
- æ‡‰è©²å…ˆåˆ†æ **è³‡æ–™æ˜¯å¦‚ä½•å¾å¾Œç«¯å‚³åˆ°å‰ç«¯çš„**
- ä¸è¦ä¸€ç›´è®“ç”¨æˆ¶åšé‡è¤‡æ¸¬è©¦
- `google.script.run` çš„åºåˆ—åŒ–é™åˆ¶æ˜¯ GAS é–‹ç™¼çš„å¸¸è¦‹é™·é˜±

---

### å•é¡Œï¼šä¿®å¾©å¾Œå ±è¡¨é é¢ã€Œç•¶æ—¥æ–°å¢ã€ä»ç‚º 0

**æ™‚é–“ç·š**ï¼š
1. ä¿®å¾© `Database.gs` çš„ Date åºåˆ—åŒ–å•é¡Œ âœ…
2. ç®¡ç†å¾Œå°å¯ä»¥é¡¯ç¤ºè³‡æ–™äº† âœ…
3. ä½†å ±è¡¨é é¢ã€Œç•¶æ—¥æ–°å¢ã€ä»é¡¯ç¤º 0 âŒ

**éŒ¯èª¤**ï¼š
- åªä¿®äº† `Database.gs`ï¼Œå¿˜äº† `Report.gs` ä¹Ÿæœ‰åŒæ¨£çš„æ—¥æœŸæ¯”è¼ƒå•é¡Œ
- `Report.gs` ä½¿ç”¨ `setHours()` + Date ç‰©ä»¶æ¯”è¼ƒï¼Œæ™‚å€ä¸ä¸€è‡´

**ä¿®å¾©**ï¼š
- åœ¨ `Report.gs` ä½¿ç”¨ `Utilities.formatDate(date, 'Asia/Taipei', 'yyyy-MM-dd')` çµ±ä¸€æ™‚å€

---

### å•é¡Œï¼šGitHub Actions æ¨é€åˆ°éŒ¯èª¤çš„ GAS å°ˆæ¡ˆ

**ç™¼ç¾éç¨‹**ï¼š
1. è¨­å®šå¥½ GitHub Actions âœ…
2. Actions åŸ·è¡ŒæˆåŠŸ âœ…
3. ä½†ç”¨æˆ¶ç™¼ç¾æ›´æ–°çš„æ˜¯èˆŠå°ˆæ¡ˆ âŒ

**åŸå› **ï¼š
- æœ¬æ©Ÿçš„ `.clasp.json` é‚„æ˜¯èˆŠçš„å°ˆæ¡ˆ ID
- Cloud Shell å»ºç«‹äº†æ–°å°ˆæ¡ˆï¼Œä½†æœ¬æ©Ÿæ²’åŒæ­¥

**ä¿®å¾©**ï¼š
- æ›´æ–° `.clasp.json` ä¸­çš„ `scriptId` ç‚ºæ–°å°ˆæ¡ˆ ID

---

### å•é¡Œï¼šworkflow æª”æ¡ˆæ”¾éŒ¯ä½ç½®

**éŒ¯èª¤**ï¼š
- æŠŠ `.github/workflows/deploy.yml` æ”¾åœ¨ `SchoolFix/.github/workflows/`
- GitHub Actions æ‰¾ä¸åˆ° workflow

**æ­£ç¢ºä½ç½®**ï¼š
- æ‡‰è©²æ”¾åœ¨ repo æ ¹ç›®éŒ„ï¼š`gas/.github/workflows/deploy.yml`

---

## ï¿½ğŸ”´ éŒ¯èª¤ 1ï¼šDate ç‰©ä»¶ç„¡æ³•é€é google.script.run åºåˆ—åŒ–

### å•é¡Œæè¿°
å¾Œç«¯å‡½å¼ `getRepairRequests` å›å‚³çš„ç‰©ä»¶é™£åˆ—ä¸­åŒ…å« Date ç‰©ä»¶ã€‚åœ¨ GAS ç·¨è¼¯å™¨æ¸¬è©¦æ­£å¸¸ï¼Œä½†é€é `google.script.run` å‘¼å«æ™‚ï¼Œå‰ç«¯æ”¶åˆ°çš„æ˜¯ `null` æˆ–ç©ºé™£åˆ—ã€‚

### éŒ¯èª¤ç¨‹å¼ç¢¼
```javascript
const request = {
  ticketId: row[0],
  reportDate: row[1],  // âŒ é€™æ˜¯ Date ç‰©ä»¶ï¼
  // ...
};
return requests; // âŒ é€é google.script.run å›å‚³æ™‚æœƒå¤±æ•—
```

### æ­£ç¢ºåšæ³•
```javascript
// âœ… å°‡ Date ç‰©ä»¶è½‰æ›ç‚º ISO å­—ä¸²
const reportDate = row[1] instanceof Date 
  ? row[1].toISOString() 
  : String(row[1] || '');

const request = {
  ticketId: String(row[0] || ''),
  reportDate: reportDate,  // âœ… å­—ä¸²
  // ...
};
```

### é‡é»
- **æ‰€æœ‰é€é google.script.run å›å‚³çš„è³‡æ–™å¿…é ˆæ˜¯å¯åºåˆ—åŒ–çš„ç´”ç‰©ä»¶**
- Dateã€RegExpã€Function ç­‰ç‰¹æ®Šç‰©ä»¶æœƒå°è‡´åºåˆ—åŒ–å¤±æ•—
- å»ºè­°æ‰€æœ‰æ¬„ä½éƒ½ç”¨ `String()` åŒ…è£ï¼Œé¿å… null/undefined

---

## ğŸ”´ éŒ¯èª¤ 2ï¼šæ—¥æœŸæ¯”è¼ƒæ™‚å€å•é¡Œ

### å•é¡Œæè¿°
å‰ç«¯å‚³é€çš„æ—¥æœŸç¯©é¸æ¢ä»¶æ ¼å¼ç‚º `2025-11-24`ï¼Œå¾Œç«¯ ISO å­—ä¸²ç‚º `2025-12-24T07:42:32.000Z`ã€‚ç›´æ¥ç”¨ `new Date()` æ¯”è¼ƒæœƒæœ‰æ™‚å€å•é¡Œã€‚

### éŒ¯èª¤ç¨‹å¼ç¢¼
```javascript
if (filters.startDate) {
  const startDate = new Date(filters.startDate);
  if (new Date(request.reportDate) < startDate) continue;  // âŒ æ™‚å€å•é¡Œ
}
```

### æ­£ç¢ºåšæ³•
```javascript
// âœ… ä½¿ç”¨æ—¥æœŸå­—ä¸²æ¯”è¼ƒï¼Œé¿å…æ™‚å€å•é¡Œ
if (filters.startDate && request.reportDate) {
  const reportDateStr = request.reportDate.substring(0, 10);  // YYYY-MM-DD
  const startDateStr = String(filters.startDate).replace(/\//g, '-');
  if (reportDateStr < startDateStr) continue;  // âœ… å­—ä¸²æ¯”è¼ƒ
}
```

---

## ğŸ”´ éŒ¯èª¤ 3ï¼šclasp push å¾Œæœªæ›´æ–°éƒ¨ç½²

### å•é¡Œæè¿°
ä½¿ç”¨ `clasp push` æ¨é€ç¨‹å¼ç¢¼å¾Œï¼Œç¶²é æ‡‰ç”¨ç¨‹å¼ä»é¡¯ç¤ºèˆŠçš„çµæœã€‚

### åŸå› 
`clasp push` åªæ›´æ–° GAS å°ˆæ¡ˆçš„ç¨‹å¼ç¢¼ï¼Œ**ä¸æœƒè‡ªå‹•æ›´æ–°å·²ç™¼å¸ƒçš„éƒ¨ç½²**ã€‚

### æ­£ç¢ºåšæ³•
æ¯æ¬¡ `clasp push` å¾Œï¼š
1. æ‰“é–‹ GAS ç·¨è¼¯å™¨
2. **éƒ¨ç½²** â†’ **ç®¡ç†éƒ¨ç½²ä½œæ¥­** â†’ **ç·¨è¼¯** â†’ **æ–°ç‰ˆæœ¬** â†’ **éƒ¨ç½²**

æˆ–ä½¿ç”¨æŒ‡ä»¤ï¼š
```bash
clasp deploy --description "v2"
```

---

## ğŸ”´ éŒ¯èª¤ 4ï¼šå·¥ä½œè¡¨ä¸å­˜åœ¨æ™‚éœé»˜å¤±æ•—

### å•é¡Œæè¿°
ç•¶ `getSheetByName()` å›å‚³ `null` æ™‚ï¼ˆå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼‰ï¼Œå¾ŒçºŒæ“ä½œæœƒå ±éŒ¯ä½†å‰ç«¯åªæ”¶åˆ°ç©ºçµæœã€‚

### éŒ¯èª¤ç¨‹å¼ç¢¼
```javascript
function getRepairRequests(filters) {
  const sheet = ss.getSheetByName(SHEETS.REQUESTS);
  const data = sheet.getDataRange().getValues();  // âŒ sheet å¯èƒ½æ˜¯ null
}
```

### æ­£ç¢ºåšæ³•
```javascript
function getRepairRequests(filters) {
  try {
    const sheet = ss.getSheetByName(SHEETS.REQUESTS);
    
    if (!sheet) {
      initializeSheets();  // âœ… è‡ªå‹•åˆå§‹åŒ–
      return [];
    }
    
    // ...
  } catch (error) {
    Logger.log('getRepairRequests error: ' + error.message);
    return [];  // âœ… å›å‚³ç©ºé™£åˆ—è€Œéè®“éŒ¯èª¤å‚³æ’­
  }
}
```

---

## ğŸ”´ éŒ¯èª¤ 5ï¼šå¤šå€‹åŒåè©¦ç®—è¡¨

### å•é¡Œæè¿°
ä½¿ç”¨ `DriveApp.getFilesByName()` æœå°‹è©¦ç®—è¡¨æ™‚ï¼Œå¦‚æœ Drive ä¸­æœ‰å¤šå€‹åŒåæª”æ¡ˆï¼Œæœƒå–åˆ°éŒ¯èª¤çš„é‚£å€‹ã€‚

### å•é¡Œ
- èˆŠå°ˆæ¡ˆå»ºç«‹äº†ã€Œæ ¡åœ’ä¿®ç¹•ç³»çµ±è³‡æ–™åº«ã€
- æ–°å°ˆæ¡ˆä¹Ÿå»ºç«‹äº†ã€Œæ ¡åœ’ä¿®ç¹•ç³»çµ±è³‡æ–™åº«ã€
- `getFilesByName()` å¯èƒ½å›å‚³èˆŠçš„

### è§£æ±ºæ–¹æ¡ˆ
1. åˆªé™¤æˆ–é‡æ–°å‘½åèˆŠçš„è©¦ç®—è¡¨
2. æˆ–ç›´æ¥ä½¿ç”¨è©¦ç®—è¡¨ IDï¼š
```javascript
function getSpreadsheet() {
  const SPREADSHEET_ID = '1KoBk0...';  // âœ… å›ºå®š ID
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}
```

---

## ğŸ”´ éŒ¯èª¤ 6ï¼šclasp login æˆæ¬Šç¢¼éæœŸ

### å•é¡Œæè¿°
åŸ·è¡Œ `clasp login --no-localhost` å¾Œï¼Œè¤‡è£½ localhost URL å› Cloud Shell æ™‚å‡ºç¾ `invalid_grant` éŒ¯èª¤ã€‚

### åŸå› 
æˆæ¬Šç¢¼æœ‰æ•ˆæ™‚é–“å¾ˆçŸ­ï¼ˆç´„ 1-2 åˆ†é˜ï¼‰ã€‚

### è§£æ±ºæ–¹æ¡ˆ
å¿«é€Ÿå®Œæˆä»¥ä¸‹æ­¥é©Ÿï¼š
1. é»æ“Šæˆæ¬Š URL
2. ç™»å…¥ä¸¦å…è¨±
3. **ç«‹å³**è¤‡è£½ localhost URL
4. è²¼å› Cloud Shell

---

## ğŸ”´ éŒ¯èª¤ 7ï¼šReport.gs å ±è¡¨æ—¥æœŸæ™‚å€å•é¡Œ

### å•é¡Œæè¿°
æ—¥å ±è¡¨ã€Œç•¶æ—¥æ–°å¢ã€é¡¯ç¤º 0ï¼Œä½†å¯¦éš›æœ‰ç•¶å¤©å ±ä¿®çš„è³‡æ–™ã€‚

### åŸå› 
`reportDate` æ˜¯ UTC æ™‚é–“çš„ ISO å­—ä¸²ï¼ˆå¦‚ `2025-12-24T07:42:32.000Z`ï¼‰ï¼Œä½†å ±è¡¨ç”¨æœ¬åœ°æ™‚é–“å»ºç«‹çš„ `startOfDay`/`endOfDay` æ¯”è¼ƒï¼Œå°è‡´æ™‚å€ä¸ä¸€è‡´ã€‚

### éŒ¯èª¤ç¨‹å¼ç¢¼
```javascript
const todayRequests = allRequests.filter(r => {
  const d = new Date(r.reportDate);  // âŒ UTC æ™‚é–“
  return d >= startOfDay && d <= endOfDay;  // âŒ æœ¬åœ°æ™‚é–“æ¯”è¼ƒ
});
```

### æ­£ç¢ºåšæ³•
```javascript
// âœ… ä½¿ç”¨ Utilities.formatDate çµ±ä¸€è½‰æ›ç‚ºå°åŒ—æ™‚é–“
const targetDateStr = Utilities.formatDate(targetDate, 'Asia/Taipei', 'yyyy-MM-dd');

const todayRequests = allRequests.filter(r => {
  if (!r || !r.reportDate) return false;
  const utcDate = new Date(r.reportDate);
  const reportDateStr = Utilities.formatDate(utcDate, 'Asia/Taipei', 'yyyy-MM-dd');
  return reportDateStr === targetDateStr;  // âœ… å­—ä¸²æ¯”è¼ƒ
});
```

### é‡é»
- **GAS ä¸­ä½¿ç”¨ `Utilities.formatDate(date, 'Asia/Taipei', 'yyyy-MM-dd')` çµ±ä¸€æ™‚å€**
- ä¸è¦ç”¨ JavaScript çš„ `setHours()` + Date æ¯”è¼ƒ

---

## ğŸŸ¢ GAS éƒ¨ç½²æœ€ä½³å¯¦è¸

### 1. è³‡æ–™åºåˆ—åŒ–
- æ‰€æœ‰å›å‚³å‰ç«¯çš„è³‡æ–™éƒ½ç”¨ç´”ç‰©ä»¶ï¼ˆå­—ä¸²ã€æ•¸å­—ã€å¸ƒæ—å€¼ï¼‰
- Date è½‰ `toISOString()`
- ç”¨ `String()` åŒ…è£å¯èƒ½æ˜¯ null çš„æ¬„ä½

### 2. éŒ¯èª¤è™•ç†
- æ‰€æœ‰ API å‡½å¼ç”¨ try-catch åŒ…è£
- å›å‚³ `{ success: true/false, error: message }`
- ä½¿ç”¨ `Logger.log()` è¨˜éŒ„éŒ¯èª¤

### 3. éƒ¨ç½²æµç¨‹
```bash
# é–‹ç™¼
git pull
# ä¿®æ”¹ç¨‹å¼ç¢¼
clasp push

# æ›´æ–°éƒ¨ç½²ï¼ˆGAS ç·¨è¼¯å™¨ï¼‰
éƒ¨ç½² â†’ ç®¡ç†éƒ¨ç½²ä½œæ¥­ â†’ ç·¨è¼¯ â†’ æ–°ç‰ˆæœ¬ â†’ éƒ¨ç½²

# æˆ–å‘½ä»¤åˆ—
clasp deploy
```

### 4. é™¤éŒ¯æŠ€å·§
- åœ¨ GAS ç·¨è¼¯å™¨åŸ·è¡Œå‡½å¼æŸ¥çœ‹ Logger è¼¸å‡º
- å‰ç«¯ç”¨ `alert()` æˆ– `console.log()` é¡¯ç¤º API å›å‚³å€¼
- æª¢æŸ¥è©¦ç®—è¡¨æ˜¯å¦æœ‰è³‡æ–™
- ç¢ºèªéƒ¨ç½²ç‰ˆæœ¬æ˜¯æœ€æ–°

### 5. æ—¥æœŸè™•ç†ï¼ˆé‡è¦ï¼ï¼‰
- **å„²å­˜**ï¼šä½¿ç”¨ `new Date()` åŸç”Ÿ Date ç‰©ä»¶
- **å›å‚³å‰ç«¯**ï¼šè½‰ç‚º ISO å­—ä¸² `toISOString()`
- **æ¯”è¼ƒæ—¥æœŸ**ï¼šä½¿ç”¨ `Utilities.formatDate(date, 'Asia/Taipei', 'yyyy-MM-dd')` å­—ä¸²æ¯”è¼ƒ

---

## ğŸ“… é–‹ç™¼æ™‚é–“è»¸

| æ—¥æœŸ | äº‹ä»¶ |
|-----|------|
| 2025-12-23 | å°ˆæ¡ˆåˆå§‹åŒ–ã€åŸºæœ¬æ¡†æ¶å®Œæˆ |
| 2025-12-24 | ç™¼ç¾è³‡æ–™æŒä¹…åŒ–å•é¡Œ |
| 2025-12-24 | ç¢ºèªå•é¡Œï¼šDate ç‰©ä»¶åºåˆ—åŒ–å¤±æ•— |
| 2025-12-24 | ä¿®å¾©ï¼šè½‰æ›æ‰€æœ‰ Date ç‚ºå­—ä¸² |
| 2025-12-24 | ä¿®å¾©ï¼šæ—¥æœŸæ¯”è¼ƒé‚è¼¯ |
| 2025-12-24 | Cloud Shell éƒ¨ç½²æˆåŠŸ âœ… |
| 2025-12-24 | ä¿®å¾©ï¼šReport.gs æ™‚å€å•é¡Œ âœ… |
| 2025-12-24 | è¨­å®š GitHub Actions è‡ªå‹•éƒ¨ç½² âœ… |
| 2025-12-24 | ä¿®æ­£ .clasp.json å°ˆæ¡ˆ ID âœ… |
| 2025-12-24 | æ¨£å¼æ›´æ–°ç‚º Flutter é¢¨æ ¼ âœ… |
| 2025-12-24 | ç¶²ç«™å“ç‰Œæ›´æ–°ï¼šåœ‹å§“åœ‹å°å ±ä¿®ç³»çµ± âœ… |
