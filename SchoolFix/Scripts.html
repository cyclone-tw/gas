<script>
    // ==================== 通用工具函數 ====================

    /**
     * 顯示 Toast 通知
     */
    function showToast(message, type = 'success') {
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
    <span>${type === 'success' ? '✅' : '❌'}</span>
    <span>${message}</span>
  `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    /**
     * 顯示/隱藏載入中
     */
    function showLoading(show = true) {
        let loading = document.querySelector('.loading-overlay');
        if (show) {
            if (!loading) {
                loading = document.createElement('div');
                loading.className = 'loading-overlay';
                loading.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;';
                loading.innerHTML = '<div class="spinner"></div>';
                document.body.appendChild(loading);
            }
            loading.style.display = 'flex';
        } else if (loading) {
            loading.style.display = 'none';
        }
    }

    /**
     * 格式化日期
     */
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    /**
     * 格式化日期（僅日期）
     */
    function formatDateOnly(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    /**
     * 取得狀態 Badge HTML
     */
    function getStatusBadge(status) {
        const badges = {
            '待處理': '<span class="badge badge-pending">待處理</span>',
            '處理中': '<span class="badge badge-progress">處理中</span>',
            '已結案': '<span class="badge badge-completed">已結案</span>'
        };
        return badges[status] || `<span class="badge">${status}</span>`;
    }

    /**
     * 取得緊急程度 Badge HTML
     */
    function getUrgencyBadge(urgency) {
        const badges = {
            '緊急': '<span class="badge badge-urgent">緊急</span>',
            '一般': '<span class="badge badge-pending">一般</span>',
            '非緊急': '<span class="badge badge-completed">非緊急</span>'
        };
        return badges[urgency] || `<span class="badge">${urgency}</span>`;
    }

    /**
     * 開啟 Modal
     */
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
        }
    }

    /**
     * 關閉 Modal
     */
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    /**
     * 切換 Tab
     */
    function switchTab(tabId, contentId) {
        // 移除所有 active
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // 設定 active
        document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
        document.getElementById(contentId)?.classList.add('active');
    }

    /**
     * 表單驗證
     */
    function validateForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return false;

        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = '#e74c3c';
                isValid = false;
            } else {
                field.style.borderColor = '';
            }
        });

        if (!isValid) {
            showToast('請填寫所有必填欄位', 'error');
        }

        return isValid;
    }

    /**
     * API 呼叫封裝
     */
    function callApi(functionName, ...args) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
            [functionName](...args);
        });
    }

    /**
     * 填充下拉選單
     */
    function populateSelect(selectId, options, placeholder = '請選擇') {
        const select = document.getElementById(selectId);
        if (!select) return;

        select.innerHTML = `<option value="">${placeholder}</option>`;

        if (Array.isArray(options)) {
            options.forEach(opt => {
                if (typeof opt === 'object') {
                    select.innerHTML += `<option value="${opt.name || opt.value}">${opt.name || opt.label}</option>`;
                } else {
                    select.innerHTML += `<option value="${opt}">${opt}</option>`;
                }
            });
        }
    }

    /**
     * 初始化 Modal 關閉事件
     */
    document.addEventListener('DOMContentLoaded', () => {
        // 點擊 overlay 關閉 modal
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ESC 鍵關閉 modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    });
</script>