<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <?!= include('Styles'); ?>
</head>

<body>
    <div class="container">
        <div class="header-bar">
            <h1>ğŸ“ å ±ä¿®ç”³è«‹</h1>
            <a href="<?= ScriptApp.getService().getUrl() ?>" class="back-link">â† è¿”å›é¦–é </a>
        </div>

        <div class="card">
            <div class="card-header">å¡«å¯«å ±ä¿®è³‡æ–™</div>
            <div class="card-body">
                <form id="repairForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å ±ä¿®äººå§“å <span class="required">*</span></label>
                            <input type="text" id="reporterName" class="form-control" required placeholder="è«‹è¼¸å…¥å§“å">
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±¬å–®ä½ <span class="required">*</span></label>
                            <select id="unit" class="form-control" required>
                                <option value="">è«‹é¸æ“‡å–®ä½</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¿®ç¹•åœ°é» <span class="required">*</span></label>
                            <select id="location" class="form-control" required>
                                <option value="">è«‹é¸æ“‡åœ°é»</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç·Šæ€¥ç¨‹åº¦ <span class="required">*</span></label>
                            <select id="urgency" class="form-control" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="ç·Šæ€¥">ğŸ”´ ç·Šæ€¥</option>
                                <option value="ä¸€èˆ¬">ğŸŸ¡ ä¸€èˆ¬</option>
                                <option value="éç·Šæ€¥">ğŸŸ¢ éç·Šæ€¥</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¿®ç¹•åˆ†é¡ <span class="required">*</span></label>
                            <select id="category" class="form-control" required onchange="onCategoryChange()">
                                <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¿®ç¹•ç´°é …</label>
                            <select id="subCategory" class="form-control">
                                <option value="">è«‹å…ˆé¸æ“‡åˆ†é¡</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ•…éšœæè¿° <span class="required">*</span></label>
                        <textarea id="description" class="form-control" required placeholder="è«‹è©³ç´°æè¿°æ•…éšœæƒ…æ³..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ç…§ç‰‡ä¸Šå‚³ï¼ˆå¯é¸ï¼‰</label>
                        <input type="file" id="photo" class="form-control" accept="image/*"
                            onchange="handlePhotoUpload(event)">
                        <div id="photoPreview" style="margin-top: 10px;"></div>
                    </div>

                    <div class="form-group">
                        <label>å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
                        <textarea id="remarks" class="form-control" placeholder="å…¶ä»–éœ€æ±‚æˆ–èªªæ˜..."></textarea>
                    </div>

                    <div style="text-align: center; padding-top: 20px;">
                        <button type="submit" class="btn btn-primary btn-block">
                            ğŸ“¤ æäº¤å ±ä¿®
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æˆåŠŸæç¤º -->
        <div id="successMessage" style="display: none;">
            <div class="card" style="text-align: center; padding: 40px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">âœ…</div>
                <h2 style="color: #27ae60; margin-bottom: 10px;">å ±ä¿®æˆåŠŸï¼</h2>
                <p style="font-size: 1.2rem; margin-bottom: 20px;">æ‚¨çš„å ±ä¿®å–®è™Ÿç‚ºï¼š<strong id="ticketNumber"></strong></p>
                <p style="color: #666; margin-bottom: 30px;">æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„å ±ä¿®ç”³è«‹ï¼Œç¸½å‹™è™•å°‡ç›¡å¿«è™•ç†ã€‚</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <a href="<?= ScriptApp.getService().getUrl() ?>?page=form" class="btn btn-primary">ç¹¼çºŒå ±ä¿®</a>
                    <a href="<?= ScriptApp.getService().getUrl() ?>" class="btn btn-outline">è¿”å›é¦–é </a>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Â© 2024 æ ¡åœ’ä¿®ç¹•ç³»çµ±</p>
        </footer>
    </div>

    <?!= include('Scripts'); ?>

    <script>
        let formData = {};
        let photoBase64 = '';

        // é é¢è¼‰å…¥
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true);
            try {
                formData = await callApi('getFormData');

                // å¡«å……ä¸‹æ‹‰é¸å–®
                populateSelect('unit', formData.units);
                populateSelect('category', formData.categories);

                // å¡«å……åœ°é»ï¼ˆå«åˆ†çµ„ï¼‰
                const locationSelect = document.getElementById('location');
                locationSelect.innerHTML = '<option value="">è«‹é¸æ“‡åœ°é»</option>';

                // ä¾åˆ†çµ„æ•´ç†
                const groups = {};
                formData.locations.forEach(loc => {
                    const group = loc.group || 'å…¶ä»–';
                    if (!groups[group]) groups[group] = [];
                    groups[group].push(loc.name);
                });

                Object.keys(groups).forEach(group => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group;
                    groups[group].forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        optgroup.appendChild(option);
                    });
                    locationSelect.appendChild(optgroup);
                });

            } catch (error) {
                showToast('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + error.message, 'error');
            }
            showLoading(false);
        });

        // åˆ†é¡è®Šæ›´æ™‚æ›´æ–°ç´°é …
        function onCategoryChange() {
            const category = document.getElementById('category').value;
            const subSelect = document.getElementById('subCategory');

            if (category && formData.subCategories && formData.subCategories[category]) {
                subSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç´°é …</option>';
                formData.subCategories[category].forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
            } else {
                subSelect.innerHTML = '<option value="">ç„¡ç´°é …</option>';
            }
        }

        // è™•ç†ç…§ç‰‡ä¸Šå‚³
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                photoBase64 = e.target.result;
                document.getElementById('photoPreview').innerHTML =
                    `<img src="${photoBase64}" style="max-width: 200px; border-radius: 8px;">`;
            };
            reader.readAsDataURL(file);
        }

        // è¡¨å–®æäº¤
        document.getElementById('repairForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!validateForm('repairForm')) return;

            showLoading(true);

            const data = {
                reporterName: document.getElementById('reporterName').value,
                unit: document.getElementById('unit').value,
                location: document.getElementById('location').value,
                category: document.getElementById('category').value,
                subCategory: document.getElementById('subCategory').value,
                description: document.getElementById('description').value,
                urgency: document.getElementById('urgency').value,
                photoUrl: photoBase64,
                remarks: document.getElementById('remarks').value
            };

            try {
                const result = await callApi('submitRepair', data);

                if (result.success) {
                    document.getElementById('repairForm').parentElement.parentElement.style.display = 'none';
                    document.getElementById('ticketNumber').textContent = result.ticketId;
                    document.getElementById('successMessage').style.display = 'block';
                } else {
                    showToast('æäº¤å¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('æäº¤å¤±æ•—: ' + error.message, 'error');
            }

            showLoading(false);
        });
    </script>
</body>

</html>