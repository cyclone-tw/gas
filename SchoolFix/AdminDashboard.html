<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <?!= include('Styles'); ?>
</head>

<body>
    <div class="container">
        <div class="header-bar">
            <h1>ğŸ“‹ ç®¡ç†å¾Œå°</h1>
            <a href="<?= ScriptApp.getService().getUrl() ?>" class="back-link">â† è¿”å›é¦–é </a>
        </div>

        <!-- çµ±è¨ˆå€å¡Š -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card danger">
                <div class="stat-value" id="statUrgent">-</div>
                <div class="stat-label">ç·Šæ€¥å¾…è™•ç†</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="statPending">-</div>
                <div class="stat-label">å¾…è™•ç†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statProgress">-</div>
                <div class="stat-label">è™•ç†ä¸­</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="statCompleted">-</div>
                <div class="stat-label">ä»Šæ—¥çµæ¡ˆ</div>
            </div>
        </div>

        <!-- ç¯©é¸å€ -->
        <div class="card">
            <div class="card-body">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>ç‹€æ…‹</label>
                        <select id="filterStatus" class="form-control" onchange="loadRequests()">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="å¾…è™•ç†">å¾…è™•ç†</option>
                            <option value="è™•ç†ä¸­">è™•ç†ä¸­</option>
                            <option value="å·²çµæ¡ˆ">å·²çµæ¡ˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>åˆ†é¡</label>
                        <select id="filterCategory" class="form-control" onchange="loadRequests()">
                            <option value="">å…¨éƒ¨åˆ†é¡</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ç·Šæ€¥ç¨‹åº¦</label>
                        <select id="filterUrgency" class="form-control" onchange="loadRequests()">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ç·Šæ€¥">ç·Šæ€¥</option>
                            <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
                            <option value="éç·Šæ€¥">éç·Šæ€¥</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>èµ·å§‹æ—¥æœŸ</label>
                        <input type="date" id="filterStartDate" class="form-control" onchange="loadRequests()">
                    </div>
                    <div class="filter-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="date" id="filterEndDate" class="form-control" onchange="loadRequests()">
                    </div>
                    <div class="filter-group" style="align-self: flex-end;">
                        <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç¯©é¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å·¥å–®åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
                <span>å·¥å–®åˆ—è¡¨</span>
                <button class="btn btn-sm btn-outline" onclick="loadRequests()"
                    style="color: white; border-color: white;">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
            <div class="card-body">
                <div id="ticketList" class="ticket-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Â© 2025 Cyclone</p>
        </footer>
    </div>

    <!-- è™•ç† Modal -->
    <div id="processModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>è™•ç†å·¥å–®</h3>
                <button class="modal-close" onclick="closeModal('processModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="processTicketId">

                <div class="form-group">
                    <label>å–®è™Ÿ</label>
                    <input type="text" id="processTicketNumber" class="form-control" readonly>
                </div>

                <div class="form-group">
                    <label>æ•…éšœæè¿°</label>
                    <textarea id="processDescription" class="form-control" readonly
                        style="background: #f5f5f5;"></textarea>
                </div>

                <div class="form-group">
                    <label>è™•ç†ç‹€æ…‹ <span class="required">*</span></label>
                    <select id="processStatus" class="form-control" required>
                        <option value="å¾…è™•ç†">å¾…è™•ç†</option>
                        <option value="è™•ç†ä¸­">è™•ç†ä¸­</option>
                        <option value="å·²çµæ¡ˆ">å·²çµæ¡ˆ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>è™•ç†äººå“¡</label>
                    <input type="text" id="processHandler" class="form-control" placeholder="è² è²¬ç¶­ä¿®äººå“¡">
                </div>

                <div class="form-group">
                    <label>è™•ç†å…§å®¹</label>
                    <textarea id="processContent" class="form-control" placeholder="è«‹èªªæ˜ç¶­ä¿®è™•ç†æƒ…å½¢..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('processModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveProcess()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- è©³æƒ… Modal -->
    <div id="detailModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>å·¥å–®è©³æƒ…</h3>
                <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
            </div>
        </div>
    </div>

    <?!= include('Scripts'); ?>

    <script>
        let allRequests = [];
        let formData = {};

        // é é¢è¼‰å…¥
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                formData = await callApi('getFormData');
                populateSelect('filterCategory', formData.categories, 'å…¨éƒ¨åˆ†é¡');

                // è¨­å®šé è¨­æ—¥æœŸç¯„åœï¼ˆæœ€è¿‘30å¤©ï¼‰
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);

                document.getElementById('filterEndDate').value = today.toISOString().split('T')[0];
                document.getElementById('filterStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];

                await loadRequests();
            } catch (error) {
                showToast('è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            }
        });

        // è¼‰å…¥å ±ä¿®å–®
        async function loadRequests() {
            const listContainer = document.getElementById('ticketList');
            listContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const filters = {
                status: document.getElementById('filterStatus').value,
                category: document.getElementById('filterCategory').value,
                urgency: document.getElementById('filterUrgency').value,
                startDate: document.getElementById('filterStartDate').value,
                endDate: document.getElementById('filterEndDate').value
            };

            try {
                const result = await callApi('getRepairs', filters);
                allRequests = result || [];
                renderRequests();
                updateStats();
            } catch (error) {
                listContainer.innerHTML = `<p style="color: #e74c3c; text-align: center;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }

        // æ¸²æŸ“å·¥å–®åˆ—è¡¨
        function renderRequests() {
            const listContainer = document.getElementById('ticketList');

            if (allRequests.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±ä¿®å–®</p>';
                return;
            }

            listContainer.innerHTML = allRequests.map(req => {
                const statusClass = req.status === 'å¾…è™•ç†' ? 'pending' :
                    req.status === 'è™•ç†ä¸­' ? 'progress' : 'completed';
                const urgentClass = req.urgency === 'ç·Šæ€¥' ? 'urgent' : '';

                return `
          <div class="ticket-card ${statusClass} ${urgentClass}">
            <div class="ticket-header">
              <span class="ticket-id">${req.ticketId}</span>
              <div>
                ${getStatusBadge(req.status)}
                ${getUrgencyBadge(req.urgency)}
              </div>
            </div>
            <div class="ticket-meta">
              <span>ğŸ“… ${formatDate(req.reportDate)}</span>
              <span>ğŸ‘¤ ${req.reporterName} (${req.unit})</span>
              <span>ğŸ“ ${req.location}</span>
            </div>
            <div class="ticket-description">
              <strong>${req.category}${req.subCategory ? ' / ' + req.subCategory : ''}</strong><br>
              ${req.description.length > 100 ? req.description.substring(0, 100) + '...' : req.description}
            </div>
            <div class="ticket-actions">
              <button class="btn btn-sm btn-outline" onclick="showDetail('${req.ticketId}')">æŸ¥çœ‹è©³æƒ…</button>
              ${req.status !== 'å·²çµæ¡ˆ' ?
                        `<button class="btn btn-sm btn-primary" onclick="openProcess('${req.ticketId}')">è™•ç†</button>` :
                        '<button class="btn btn-sm btn-success" disabled>å·²çµæ¡ˆ</button>'}
            </div>
          </div>
        `;
            }).join('');
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            const allData = allRequests;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const urgent = allData.filter(r => r.urgency === 'ç·Šæ€¥' && r.status === 'å¾…è™•ç†').length;
            const pending = allData.filter(r => r.status === 'å¾…è™•ç†').length;
            const progress = allData.filter(r => r.status === 'è™•ç†ä¸­').length;
            const todayCompleted = allData.filter(r => {
                if (r.status !== 'å·²çµæ¡ˆ' || !r.completeTime) return false;
                const completeDate = new Date(r.completeTime);
                return completeDate >= today;
            }).length;

            document.getElementById('statUrgent').textContent = urgent;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statProgress').textContent = progress;
            document.getElementById('statCompleted').textContent = todayCompleted;
        }

        // æ¸…é™¤ç¯©é¸
        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterUrgency').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            loadRequests();
        }

        // é–‹å•Ÿè™•ç† Modal
        function openProcess(ticketId) {
            const req = allRequests.find(r => r.ticketId === ticketId);
            if (!req) return;

            document.getElementById('processTicketId').value = ticketId;
            document.getElementById('processTicketNumber').value = ticketId;
            document.getElementById('processDescription').value = req.description;
            document.getElementById('processStatus').value = req.status;
            document.getElementById('processHandler').value = req.handler || '';
            document.getElementById('processContent').value = req.handlerContent || '';

            openModal('processModal');
        }

        // å„²å­˜è™•ç†
        async function saveProcess() {
            const ticketId = document.getElementById('processTicketId').value;
            const data = {
                status: document.getElementById('processStatus').value,
                handler: document.getElementById('processHandler').value,
                handlerContent: document.getElementById('processContent').value
            };

            showLoading(true);

            try {
                const result = await callApi('updateRepair', ticketId, data);

                if (result.success) {
                    showToast('æ›´æ–°æˆåŠŸï¼');
                    closeModal('processModal');
                    loadRequests();
                } else {
                    showToast('æ›´æ–°å¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('æ›´æ–°å¤±æ•—: ' + error.message, 'error');
            }

            showLoading(false);
        }

        // é¡¯ç¤ºè©³æƒ…
        function showDetail(ticketId) {
            const req = allRequests.find(r => r.ticketId === ticketId);
            if (!req) return;

            document.getElementById('detailContent').innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; width: 100px;">å–®è™Ÿ</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.ticketId}</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">å ±ä¿®æ—¥æœŸ</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${formatDate(req.reportDate)}</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">å ±ä¿®äºº</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.reporterName} (${req.unit})</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">åœ°é»</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.location}</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">åˆ†é¡</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.category}${req.subCategory ? ' / ' + req.subCategory : ''}</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">ç·Šæ€¥ç¨‹åº¦</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${getUrgencyBadge(req.urgency)}</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">ç‹€æ…‹</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${getStatusBadge(req.status)}</td></tr>
          <tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; vertical-align: top;">æ•…éšœæè¿°</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.description}</td></tr>
          ${req.remarks ? `<tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; vertical-align: top;">å‚™è¨»</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.remarks}</td></tr>` : ''}
          ${req.handler ? `<tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold;">è™•ç†äººå“¡</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.handler}</td></tr>` : ''}
          ${req.handlerContent ? `<tr><td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; vertical-align: top;">è™•ç†å…§å®¹</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${req.handlerContent}</td></tr>` : ''}
          ${req.completeTime ? `<tr><td style="padding: 10px; font-weight: bold;">å®Œæˆæ™‚é–“</td><td style="padding: 10px;">${formatDate(req.completeTime)}</td></tr>` : ''}
        </table>
        ${req.photoUrl ? `<div style="margin-top: 20px;"><strong>å ±ä¿®ç…§ç‰‡ï¼š</strong><br><img src="${req.photoUrl}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;"></div>` : ''}
      `;

            openModal('detailModal');
        }
    </script>
</body>

</html>